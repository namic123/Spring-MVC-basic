# 동시 요청 - 멀티 쓰레드
* 클라이언트로부터 요청이 들어오면 WAS에서 아래와 같은 과정을 거친다.
1. TCP/IP 연결: 클라이언트의 요청이 들어오면, 서버는 TCP/IP 프로토콜을 사용하여 네트워크를 통해 데이터를 전송하고 받는 소켓 연결을 수립
2. 쓰레드 할당: WAS는 요청을 처리할 새로운 쓰레드를 할당하거나, 쓰레드 풀에서 대기 중인 쓰레드를 재사용하여 요청을 처리
3. 서블릿 객체 호출: 쓰레드는 서버 구성에 따라 요청 URL과 매핑된 서블릿 객체를 찾아 'service'메서드를 호출한다. 

## Thread(쓰레드)
쓰레드는 애플리케이션 코드를 하나씩 순차적으로 실행한다. Java로 예를 들어, 메인 메서드를 실행하면 main이라는 이름의 쓰레드가 실행되는 것이다.
즉, 쓰레드가 없다면 자바 애플리케이션 실행이 불가능하고, 하나의 쓰레드는 "한번에 하나의 코드 라인"만을 수행한다. 
동시 처리가 필요한 경우 쓰레드를 추가로 생성해야한다. 

[단일 요청 쓰레드 - 쓰레드 한개 사용]
* 단일 요청이 올 경우, 하나의 쓰레드가 할당이 되며 해당하는 Servlet 객체를 호출하여 코드를 실행
* 응답 후, 쓰레드 휴식 

[다중 요청 - 쓰레드 한개 사용]
* 쓰레드 한개로 다중 요청을 처리하게되면, 해당 쓰레드가 요청을 처리완료 할 때까지 다른 요청은 쓰레드 대기 상태가된다.
* 이 경우, 처리중인 요청에서 처리 지연으로 쓰레드 타임아웃이 날 경우, 다른 모든 요청에도 에러가 발생하는 문제점이 발생할 수 있음. 

[요청마다 쓰레드 생성]
* 위와 같은 문제를 해결하기 위해 요청마다 신규 쓰레드를 생성 
* 그러나 요청 마다 쓰레드를 생성하는 방식은 장단점이 있다.
  * 장점
    * 동시 요청 처리 가능
    * 리소스(CPU, 메모리)가 허용할 때 까지 처리가능
    * 하나의 쓰레드가 지연되어도, 나머지 쓰레드는 정상 동작
  * 단점
    * 쓰레드의 생성 비용이 매우 비싸다.
      * 고객 요청이 올 때마다 쓰레드를 생성하면, 응답 속도가 늦어짐
    * 쓰레드는 컨텍스트 스위칭 비용이 발생(운영체제가 CPU의 실행을 한 쓰레드에서 다른 쓰레드로 전환하는 과정에서 발생되는 비용)
    * 쓰레드 생성에 제한이 없다.
      * 고객 요청이 너무 많이 오면, CPU, 메모리 임계점을 넘어서 서버가 죽을 수 있음. 

[쓰레드 풀 - 요청 마다 쓰레드 생성의 단점을 보완]
* 필요한 쓰레드를 쓰레드 풀에 보관하고 관리
* 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리하며, 톰캣은 최대 200개가 기본 설정으로 되어있다.
* 쓰레드가 필요할 경우, 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용하며, 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납
* 최대 쓰레드가 모두 사용중인 경우, 기다리는 요청은 거절되거나 특정 숫자만큼만 대기하도록 설정할 수 있다.

[쓰레드 풀 - 장점]
* 쓰레드가 미리 생성되어 있으므로, 생성하고 종료하는 비용(CPU)이 절약되고 응답 시간이 빠르다.
* 생성 가능한 쓰레드의 최대치가 있기 떄문에 많은 요청이 들어와도 기존 요청을 안전하게 처리할 수 있다.

[쓰레드 풀 - 실무 팁]
* WAS의 주요 튜닝 포인트는 최대 쓰레드의 수이다.
* 최대 쓰레드 수 값이 너무 낮을 경우
  * 동시 요청이 많은 경우, 서버 리스소는 여유(예:CPU를 5퍼만 사용)롭지만, 클라이언트는 요청이 많을수록 응답이 지연
* 최대 쓰레드 수 값이 높은 경우,
  * 동시 욫청이 많은 경우, cpu, 메모리 리소스 임계점 초과로 서버 다운